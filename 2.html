<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trung Thu</title>
    <style>
        :root {
            --accent: #ff7f50;
            --accent-2: #ff5722;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, "Segoe UI", system-ui, sans-serif;
            background: #060614;
            overflow: hidden;
        }

        .stage {
            position: relative;
            min-height: 100vh;
            overflow: hidden;
        }

        canvas#starfield,
        canvas#fireworks {
            display: block;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }

        canvas#fireworks {
            z-index: 1;
        }

        /* CHỈNH SỬA 1: MẶT TRĂNG - Vị trí 3% (phải), 2.5% (trên) và kích thước 168px (to thêm 0.4 lần) */
        .moon {
            position: fixed;
            top: 2.5%;
            right: 3%;
            width: 168px;
            height: 168px;
            background: radial-gradient(circle at 30% 30%, #fff 0%, #f0f0f0 45%, #dcdcdc 100%);
            border-radius: 50%;
            box-shadow: 
                0 0 30px rgba(255, 255, 210, 0.8),
                0 0 60px rgba(255, 240, 200, 0.5);
            pointer-events: none;
            z-index: 2;
        }

        #lantern-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }

        .lantern {
            position: absolute;
            pointer-events: auto;
            width: 40px;
            user-select: none;
        }

        @keyframes swing {
            0% {
                transform: rotate(-5deg);
            }

            50% {
                transform: rotate(5deg);
            }

            100% {
                transform: rotate(-5deg);
            }
        }

        .swing {
            animation: swing 2s ease-in-out infinite;
        }

        /* CHỈNH SỬA 2: THÊM KEYFRAMES CHO HIỆU ỨNG TỰ ĐỘNG HIỂN THỊ CỦA POPUP */
        @keyframes fade-in-out {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); }
        }

        #wish-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.96);
            color: var(--accent-2);
            font-family: Inter, "Segoe UI", system-ui, sans-serif;
            padding: 28px 20px;
            border-radius: 12px;
            font-size: 1.05rem;
            font-weight: 700;
            opacity: 0; 
            animation: none;
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.35);
            text-align: center;
            max-width: 90%;
            box-sizing: border-box;
        }

        #hint {
            position: fixed;
            bottom: 8vh;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 14px;
            background: linear-gradient(90deg, rgba(255, 127, 80, 0.95), rgba(255, 87, 34, 0.95));
            color: white;
            border-radius: 999px;
            font-weight: 600;
            z-index: 9998;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            opacity: 0;
            transition: opacity .35s ease;
            pointer-events: none;
            white-space: pre-line;
        }

        .controls {
            position: fixed;
            left: 18px;
            top: 18px;
            z-index: 10;
            color: #fff;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 10px;
        }

        .music-toggle {
            cursor: pointer;
            margin-left: 10px;
            color: #fff;
            opacity: 0.95;
        }

        /* CHỈNH SỬA 4: DÒNG CHỮ "Đêm Hội Trung Thu" - Di chuyển vào giữa và lên cao */
        .title-text {
            position: fixed;
            top: 4vh; 
            left: 50%;
            transform: translateX(-50%);
            right: auto;
            color: #ffd07a;
            font-size: 2.4rem;
            font-weight: 800;
            text-shadow: 0 0 12px rgba(255,200,120,0.9), 0 0 30px rgba(255,140,60,0.5);
            z-index: 50;
            pointer-events: none;
            font-family: "Segoe UI", system-ui, sans-serif;
            white-space: nowrap;
        }

        @media (max-width:600px) {
            .moon {
                top: 2vh;
                right: 3vw;
                width: 100px;
                height: 100px;
                box-shadow: 0 0 12px rgba(255, 240, 200, 0.6);
            }

            #wish-popup {
                font-size: 0.95rem;
                padding: 16px 12px;
            }

            #hint {
                font-size: 0.9rem;
                bottom: 12vh;
            }

            .title-text {
                top: 4vh;
                font-size: 1.6rem;
            }
        }
    </style>
</head>

<body>
    <div class="stage">
        <canvas id="starfield"></canvas>
        <canvas id="fireworks"></canvas>

        <div class="moon" aria-hidden="true"></div>

        <div id="lantern-container"></div>

        <div id="wish-popup" role="dialog" aria-live="polite"></div>

        <div id="hint">Chạm màn hình để mở nhạc và thả đèn ✨</div>

        <div class="controls">
            <span class="music-toggle" id="musicToggle"></span>
        </div>

        <div class="title-text">Đêm Hội Trung Thu</div>
    </div>

    <audio id="bg-music" loop preload="auto">
        <source src="anh_se_cho_minh.mp3.mp3" type="audio/mp3">
        Trình duyệt của bạn không hỗ trợ thẻ audio.
    </audio>


    <script>
        /* --- Code bầu trời sao + lồng đèn (giữ nguyên) --- */
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let w, h, stars = [], meteors = [];
        function resizeCanvas() {
            w = canvas.width = innerWidth;
            h = canvas.height = innerHeight;
            stars = [];
            const count = Math.round((w * h) / 2200);
            for (let i = 0; i < count; i++) {
                stars.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    r: Math.random() * 0.9 + 0.1,
                    a: Math.random() * 0.8 + 0.2,
                    t: Math.random() * 0.02 + 0.002
                });
            }
        }
        function drawStars() {
            ctx.clearRect(0, 0, w, h);
            for (const s of stars) {
                s.a += (Math.random() > 0.5 ? 1 : -1) * s.t;
                s.a = Math.max(0.05, Math.min(1, s.a));
                ctx.beginPath();
                ctx.globalAlpha = s.a;
                ctx.fillStyle = '#fff';
                ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
        }
        function createMeteor() {
            const startX = Math.random() * w;
            const startY = Math.random() * (h / 3);
            const speed = Math.random() * 10 + 6;
            meteors.push({
                x: startX, y: startY, vx: speed + 6, vy: speed / 2, len: Math.random() * 120 + 100, a: 1
            });
        }
        function drawMeteors() {
            for (let i = meteors.length - 1; i >= 0; i--) {
                const m = meteors[i];
                const x2 = m.x - m.len;
                const y2 = m.y - m.len / 2;
                const g = ctx.createLinearGradient(m.x, m.y, x2, y2);
                g.addColorStop(0, `rgba(255,255,255,${m.a})`);
                g.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.strokeStyle = g;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(m.x, m.y);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                m.x += m.vx; m.y += m.vy; m.a -= 0.02;
                if (m.a <= 0 || m.x > w + 200 || m.y > h + 200) meteors.splice(i, 1);
            }
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
        }
        function loop() {
            drawStars();
            drawMeteors();
            if (Math.random() < 0.01) createMeteor();
            requestAnimationFrame(loop);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        loop();

        const lanternContainer = document.getElementById('lantern-container');
        const wishes = [
            "Tớ chúc mọi điều tốt đẹp nhất đến với cậu.",
            "Trăng tròn rồi, tớ chỉ muốn nắm tay cậu.",
            "Cậu làm tim tớ rung rinh mỗi lần cười.",
            "Có cậu cạnh bên, mùa trăng nào cũng đặc biệt."
        ];

        function createLantern() {
            const lantern = document.createElement("img");
            lantern.src = "https://github.com/Panbap/Trungthu/blob/main/den.png?raw=true";
            lantern.className = "lantern swing";

            const layer = Math.floor(Math.random() * 3) + 1;
            let size = 40, duration = 10000, opacity = 0.8;

            if (layer === 1) { size = 20 + Math.random() * 20; duration = 14000 + Math.random() * 5000; opacity = 0.5; }
            else if (layer === 2) { size = 30 + Math.random() * 30; duration = 12000 + Math.random() * 4000; opacity = 0.7; }
            else { size = 40 + Math.random() * 40; duration = 10000 + Math.random() * 3000; opacity = 0.95; }

            lantern.style.width = size + "px";
            lantern.style.left = Math.random() * 90 + "vw";
            lantern.style.bottom = "0px";
            lantern.style.opacity = opacity;

            lanternContainer.appendChild(lantern);

            const drift = Math.random() * 140 - 70;
            const up = 120 + Math.random() * 40;
            lantern.animate([
                { transform: "translate(0,0)", opacity: opacity },
                { transform: `translate(${drift}px, -${up}vh)`, opacity: 0 }
            ], { duration: duration, easing: "linear", fill: "forwards" });

            setTimeout(() => lantern.remove(), duration);
        }

        // TĂNG SỐ LƯỢNG LỒNG ĐÈN
        setInterval(createLantern, 300); 
        for (let i = 0; i < 6; i++) { setTimeout(createLantern, i * 400); }


        /* --- LỜI CHÚC TỰ ĐỘNG HIỂN THỊ --- */
        const wishPopup = document.getElementById('wish-popup');
        let currentWishIndex = 0;

        function showNextWish() {
            wishPopup.textContent = wishes[currentWishIndex];
            wishPopup.style.animation = 'fade-in-out 4s ease-in-out forwards';
            
            setTimeout(() => {
                wishPopup.style.animation = 'none';
            }, 4000);

            currentWishIndex = (currentWishIndex + 1) % wishes.length;
        }

        setInterval(showNextWish, 6000); 
        showNextWish();
        /* --- KẾT THÚC CHỈNH SỬA LỜI CHÚC TỰ ĐỘNG --- */


        /* --- Nhạc nền & Hint TỐI ƯU HÓA --- */
        const bg = document.getElementById('bg-music');
        const musicToggle = document.getElementById('musicToggle');
        let musicStarted = false;

        // HÀM MỚI: Chỉ để hiển thị và ẩn dòng chữ gợi ý
        function showHint() {
            const hint = document.getElementById('hint');
            if (hint.style.opacity !== '1') { // Kiểm tra để không lặp lại nếu đã hiện
                hint.style.opacity = '1';
                setTimeout(() => hint.style.opacity = '0', 3500);
            }
        }

        function startMusic() {
            if (musicStarted) return;
            if (!bg) return;
            
            bg.volume = 0.0;
            bg.play().then(() => {
                let v = 0;
                const i = setInterval(() => {
                    v += 0.05;
                    if (v >= 0.9) { v = 0.9; clearInterval(i); }
                    bg.volume = v;
                }, 120);
                musicStarted = true;
                musicToggle.textContent = '🔊';
            }).catch(() => {
                console.warn('Không thể phát nhạc tự động (bị chặn).');
            });
        }

        musicToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!musicStarted) { startMusic(); return; }
            if (bg.paused) { bg.play(); musicToggle.textContent = '🔊'; }
            else { bg.pause(); musicToggle.textContent = '🔈'; }
        });

        // Gọi startMusic khi người dùng chạm/nhấp lần đầu (để vượt chặn autoplay)
        document.addEventListener('pointerdown', function onceStart() {
            startMusic();
            document.removeEventListener('pointerdown', onceStart);
        });
        
        // --- CHỈNH SỬA MỚI: TỰ ĐỘNG HIỂN THỊ DÒNG CHỮ SAU 3 GIÂY ---
        window.addEventListener('load', () => {
            setTimeout(showHint, 3000); // Gọi showHint sau 3 giây (3000ms)
        });
        // --- KẾT THÚC CHỈNH SỬA MỚI ---

        document.addEventListener('click', (e) => {
            // Vẫn giữ lại phần này, dù popup hiển thị tự động
        });


        /* --- Code pháo hoa (giữ nguyên) --- */
        const fwCanvas = document.getElementById("fireworks");
        const fctx = fwCanvas.getContext("2d");
        let cw, ch;
        function resizeFW() {
            cw = fwCanvas.width = window.innerWidth;
            ch = fwCanvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resizeFW);
        resizeFW();

        function random(min, max) { return Math.random() * (max - min) + min; }
        function distance(ax, ay, bx, by) { const dx = bx - ax, dy = by - ay; return Math.sqrt(dx * dx + dy * dy); }

        class Firework {
            constructor(sx, sy, tx, ty) {
                this.x = sx; this.y = sy; this.sx = sx; this.sy = sy; this.tx = tx; this.ty = ty;
                this.distanceToTarget = distance(sx, sy, tx, ty);
                this.distanceTraveled = 0;
                this.coordinates = [];
                this.coordinateCount = 3;
                while (this.coordinateCount--) { this.coordinates.push([this.x, this.y]); }
                this.angle = Math.atan2(ty - sy, tx - sx);
                this.speed = 5; this.acceleration = 1.05;
                this.brightness = random(50, 70); this.targetRadius = 8;
            }
            update(i) {
                this.coordinates.pop();
                this.coordinates.unshift([this.x, this.y]);
                this.speed *= this.acceleration;
                const vx = Math.cos(this.angle) * this.speed, vy = Math.sin(this.angle) * this.speed;
                this.distanceTraveled = distance(this.sx, this.sy, this.x + vx, this.y + vy);
                if (this.distanceTraveled >= this.distanceToTarget) {
                    createParticles(this.tx, this.ty);
                    fireworks.splice(i, 1);
                } else { this.x += vx; this.y += vy; }
            }
            draw() {
                fctx.beginPath();
                fctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                fctx.lineTo(this.x, this.y);
                fctx.strokeStyle = `hsl(${random(0, 360)}, 100%, ${this.brightness}%)`;
                fctx.stroke();
            }
        }

        class Particle {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.coordinates = []; this.coordinateCount = 5;
                while (this.coordinateCount--) { this.coordinates.push([this.x, this.y]); }
                this.angle = random(0, Math.PI * 2);
                this.speed = random(1, 10); this.friction = 0.95; this.gravity = 0.7;
                this.hue = random(0, 360); this.brightness = random(50, 80);
                this.alpha = 1; this.decay = random(0.015, 0.03);
            }
            update(i) {
                this.coordinates.pop();
                this.coordinates.unshift([this.x, this.y]);
                this.speed *= this.friction;
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed + this.gravity;
                this.alpha -= this.decay;
                if (this.alpha <= 0) { particles.splice(i, 1); }
            }
            draw() {
                fctx.beginPath();
                fctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                fctx.lineTo(this.x, this.y);
                fctx.strokeStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`;
                fctx.stroke();
            }
        }

        function createParticles(x, y) {
            let count = 30;
            while (count--) { particles.push(new Particle(x, y)); }
        }

        let fireworks = [], particles = [];
        function loopFW() {
            requestAnimationFrame(loopFW);
            fctx.globalCompositeOperation = 'destination-out';
            fctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            fctx.fillRect(0, 0, cw, ch);
            fctx.globalCompositeOperation = 'lighter';
            for (let i = fireworks.length - 1; i >= 0; i--) { fireworks[i].draw(); fireworks[i].update(i); }
            for (let i = particles.length - 1; i >= 0; i--) { particles[i].draw(); particles[i].update(i); }
            if (fireworks.length < 5) {
                fireworks.push(new Firework(cw / 2, ch, random(100, cw - 100), random(50, ch / 2)));
            }
        }
        loopFW();
    </script>
</body>

</html>